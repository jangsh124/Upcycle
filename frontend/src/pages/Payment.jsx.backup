import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';
import './Payment.css';

const Payment = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [product, setProduct] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState('card');
  const [cardNumber, setCardNumber] = useState('');
  const [cardExpiry, setCardExpiry] = useState('');
  const [cardCVC, setCardCVC] = useState('');
  const [cryptoAddress, setCryptoAddress] = useState('');
  const [processing, setProcessing] = useState(false);

  useEffect(() => {
    const fetchProduct = async () => {
      try {
        const response = await axios.get(`/api/products/${id}`);
        setProduct(response.data);
      } catch (err) {
        setError('μƒν’ μ •λ³΄λ¥Ό λ¶λ¬μ¤λ”λ° μ‹¤ν¨ν–μµλ‹λ‹¤.');
      } finally {
        setLoading(false);
      }
    };

    fetchProduct();
  }, [id]);

  const handleCardPayment = async () => {
    if (!cardNumber || !cardExpiry || !cardCVC) {
      alert('λ¨λ“  μΉ΄λ“ μ •λ³΄λ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”.');
      return;
    }

    setProcessing(true);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('λ΅κ·ΈμΈμ΄ ν•„μ”ν•©λ‹λ‹¤.');
        navigate('/login');
        return;
      }

      const orderData = sessionStorage.getItem('pendingOrder');
      if (!orderData) {
        alert('μ£Όλ¬Έ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤.');
        navigate(`/products/${id}`);
        return;
      }

      const order = JSON.parse(orderData);
      
      const response = await axios.post('/api/orders', {
        productId: id,
        type: order.type,
        price: order.price,
        quantity: order.quantity,
        paymentMethod: 'card',
        cardNumber: cardNumber.slice(-4) // λ§μ§€λ§‰ 4μλ¦¬λ§ μ €μ¥
      }, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (response.data.success) {
        alert('μΉ΄λ“ κ²°μ κ°€ μ™„λ£λμ—μµλ‹λ‹¤!');
        sessionStorage.removeItem('pendingOrder');
        navigate(`/products/${id}`);
      }
    } catch (err) {
      console.error('μΉ΄λ“ κ²°μ  μ‹¤ν¨:', err);
      alert('μΉ΄λ“ κ²°μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
    } finally {
      setProcessing(false);
    }
  };

  const handleCryptoPayment = async () => {
    if (!cryptoAddress) {
      alert('μ•”νΈν™”ν μ£Όμ†λ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”.');
      return;
    }

    setProcessing(true);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('λ΅κ·ΈμΈμ΄ ν•„μ”ν•©λ‹λ‹¤.');
        navigate('/login');
        return;
      }

      const orderData = sessionStorage.getItem('pendingOrder');
      if (!orderData) {
        alert('μ£Όλ¬Έ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤.');
        navigate(`/products/${id}`);
        return;
      }

      const order = JSON.parse(orderData);
      
      const response = await axios.post('/api/orders', {
        productId: id,
        type: order.type,
        price: order.price,
        quantity: order.quantity,
        paymentMethod: 'crypto',
        cryptoAddress: cryptoAddress
      }, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (response.data.success) {
        alert('μ•”νΈν™”ν κ²°μ κ°€ μ™„λ£λμ—μµλ‹λ‹¤!');
        sessionStorage.removeItem('pendingOrder');
        navigate(`/products/${id}`);
      }
    } catch (err) {
      console.error('μ•”νΈν™”ν κ²°μ  μ‹¤ν¨:', err);
      alert('μ•”νΈν™”ν κ²°μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
    } finally {
      setProcessing(false);
    }
  };

  const handleCancel = () => {
    sessionStorage.removeItem('pendingOrder');
    navigate(`/products/${id}`);
  };

  if (loading) return <div className="payment-container">λ΅λ”© μ¤‘...</div>;
  if (error) return <div className="payment-container">{error}</div>;
  if (!product) return <div className="payment-container">μƒν’μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤.</div>;

  const orderData = sessionStorage.getItem('pendingOrder');
  const order = orderData ? JSON.parse(orderData) : null;

  if (!order) {
    return (
      <div className="payment-container">
        <h2>μ£Όλ¬Έ μ •λ³΄κ°€ μ—†μµλ‹λ‹¤.</h2>
        <button onClick={() => navigate(`/products/${id}`)}>
          μƒν’ νμ΄μ§€λ΅ λμ•„κ°€κΈ°
        </button>
      </div>
    );
  }

  return (
    <div className="payment-container">
      <h2>κ²°μ  νμ΄μ§€</h2>
      
      <div className="product-info">
        <h3>{product.name}</h3>
        <p>{product.description}</p>
      </div>

      <div className="order-summary">
        <h3>μ£Όλ¬Έ λ‚΄μ—­</h3>
        <div className="order-details">
          <p><strong>μ£Όλ¬Έ μ ν•:</strong> {order.type === 'buy' ? 'λ§¤μ' : 'λ§¤λ„'}</p>
          <p><strong>κ°€κ²©:</strong> {order.price.toLocaleString()}μ›</p>
          <p><strong>μλ‰:</strong> {order.quantity.toLocaleString()}κ°</p>
          <p><strong>μ΄μ•΅:</strong> {(order.price * order.quantity).toLocaleString()}μ›</p>
        </div>
      </div>

      <div className="payment-methods">
        <h3>κ²°μ  λ°©λ²• μ„ νƒ</h3>
        <div className="method-buttons">
          <button 
            className={`method-btn ${paymentMethod === 'card' ? 'active' : ''}`}
            onClick={() => setPaymentMethod('card')}
          >
            π’³ μΉ΄λ“ κ²°μ 
          </button>
          <button 
            className={`method-btn ${paymentMethod === 'crypto' ? 'active' : ''}`}
            onClick={() => setPaymentMethod('crypto')}
          >
            β‚Ώ μ•”νΈν™”ν κ²°μ 
          </button>
        </div>
      </div>

      {paymentMethod === 'card' && (
        <div className="card-payment-form">
          <h3>μΉ΄λ“ μ •λ³΄ μ…λ ¥</h3>
          <div className="form-group">
            <label>μΉ΄λ“ λ²νΈ:</label>
            <input
              type="text"
              value={cardNumber}
              onChange={(e) => setCardNumber(e.target.value)}
              placeholder="1234 5678 9012 3456"
              maxLength="19"
            />
          </div>
          <div className="form-row">
            <div className="form-group">
              <label>λ§λ£μΌ:</label>
              <input
                type="text"
                value={cardExpiry}
                onChange={(e) => setCardExpiry(e.target.value)}
                placeholder="MM/YY"
                maxLength="5"
              />
            </div>
            <div className="form-group">
              <label>CVC:</label>
              <input
                type="text"
                value={cardCVC}
                onChange={(e) => setCardCVC(e.target.value)}
                placeholder="123"
                maxLength="3"
              />
            </div>
          </div>
          <button 
            className="payment-btn confirm" 
            onClick={handleCardPayment}
            disabled={processing}
          >
            {processing ? 'μ²λ¦¬ μ¤‘...' : 'μΉ΄λ“λ΅ κ²°μ ν•κΈ°'}
          </button>
        </div>
      )}

      {paymentMethod === 'crypto' && (
        <div className="crypto-payment-form">
          <h3>μ•”νΈν™”ν κ²°μ </h3>
          <div className="form-group">
            <label>μ•”νΈν™”ν μ£Όμ†:</label>
            <input
              type="text"
              value={cryptoAddress}
              onChange={(e) => setCryptoAddress(e.target.value)}
              placeholder="0x1234567890abcdef..."
            />
          </div>
          <div className="crypto-info">
            <p><strong>μ§€μ› μ•”νΈν™”ν:</strong> Bitcoin, Ethereum, USDT</p>
            <p><strong>κ²°μ  κΈμ•΅:</strong> {(order.price * order.quantity).toLocaleString()}μ›</p>
          </div>
          <button 
            className="payment-btn confirm" 
            onClick={handleCryptoPayment}
            disabled={processing}
          >
            {processing ? 'μ²λ¦¬ μ¤‘...' : 'μ•”νΈν™”νλ΅ κ²°μ ν•κΈ°'}
          </button>
        </div>
      )}

      <div className="payment-actions">
        <button className="payment-btn cancel" onClick={handleCancel}>
          μ·¨μ†
        </button>
      </div>
    </div>
  );
};

export default Payment;
